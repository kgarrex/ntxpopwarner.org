<Project>
  <Target Name="Tailwind" AfterTargets="Build">
    <PropertyGroup>
      <UseStaticTailwind>true</UseStaticTailwind>
      <TailwindVersion>3.4.3</TailwindVersion>
      <DestinationFileName>tailwindcss.exe</DestinationFileName>
      <SourceUrl>https://github.com/tailwindlabs/tailwindcss/releases/download/v$(TailwindVersion)/tailwindcss-windows-x64.exe</SourceUrl>
      <InputCss>in.css</InputCss>
      <OutputCss>$(ProjectDir)wwwroot/css/out.css</OutputCss>
    </PropertyGroup>

    <ItemGroup>
      <SearchList Include="$(ProjectDir)$(DestinationFileName)" />
      <SearchList Include="$(ProjectDir)bin\$(DestinationFileName)" />
      <SearchList Condition="$(SolutionDir) != ''" Include="$(ProjectDir)$(SolutionDir)$(DestinationFileName)" />
      <SearchList Include="$(OutDir)$(DestinationFileName)" />
      <SearchList Include="C:\Windows\SysWOW64\$(DestinationFileName)" />
    </ItemGroup>

    <ItemGroup>
      <Files Include="@OutputCss" />
    </ItemGroup>

    <!-- Search for the tailwindcss executable -->
    <Message Text="Searching for tailwindcss..." Importance="high" />
    <FindInList ItemSpecToFind="$(DestinationFileName)" List="@(SearchList)" MatchFileNameOnly="false">
      <Output TaskParameter="ItemFound" ItemName="TailwindExe" />
    </FindInList>

    <Message Text="Exe: @(SearchList)" Importance="high" />

    <!-- Download the tailwindcss executable if not found -->
    <DownloadFile
    Condition="@(TailwindExe) == '' Or !Exists('@(TailwindExe)')"
    SourceUrl="$(SourceUrl)"
    DestinationFolder="$(ProjectDir)bin\"
    DestinationFileName="$(DestinationFileName)">
      <Output TaskParameter="DownloadedFile" ItemName="TailwindExe" />
    </DownloadFile>

    <Message Text="@(TailwindExe)" Importance="high" />

    <!-- If download failed, we stop the build and throw an error -->
    <Error
    Condition="@(TailwindExe) == '' Or !Exists('@(TailwindExe)')"
    Text="Failed to download Tailwind executable"
    HelpLink="https://github.com/tailwindlabs/tailwindcss/releases/latest"
    />

	    <!-- <Delete Files="@(Files)" TreatErrorsAsWarnings="false" /> -->

    <!-- Run the tailwindcss executable  statically -->
    <Exec Condition="$(UseStaticTailwind) == 'true'" Command="@(TailwindExe) -i $(InputCss) -o $(OutputCss) --minify">
      <Output TaskParameter="ExitCode" PropertyName="TailwindResult" />
    </Exec>

    <!-- Install tailwind middleware packaege to build tailwind dynamically -->
    <!--
    <Exec Condtion="" Command="nuget add $(Pillar.Tailwind) -Source $(UserProfile)\.nuget\packages">
      <Output TaskParameter="ExitCode" PropertyName="TailwindResult" />
    </Exec>
    -->

    <Error Condition="$(TailwindResult) > 0" Text="Tailwind failed ($(TailwindResult))" />
  </Target>


  <!-- Deploys a nuget package to the specified array or source indices -->
  <Target Name="Deploy" Condition="$(_IsPublishing) == 'true' And $(PackageId) != ''" >
    <ItemGroup>
      <SourceIndex Include="https://api.nuget.org/v3/index.json" /> 
    </ItemGroup>
    
    <NugetPush NupkgFile="" SourceIndex="@(SourceIndex)" />
  </Target>
</Project>
